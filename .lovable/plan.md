# Анализ логов и план оптимизации сайта

## Найденные проблемы

### 1. Дублирование запросов новостей (Производительность)

На главной странице новости загружаются **дважды** разными путями:

- `PrefetchData.tsx` использует ключ `['news', 'all', 1, 15]` и вызывает `fetchNews()`
- `NewsSection.tsx` использует ключ `['news', 'homepage']` и тоже вызывает `fetchNews()`

Результат: 2 идентичных запроса к `news_articles` (видно в сетевых запросах — два GET на `news_articles` с разницей в 1 секунду). Каждый загружает 100 статей, хотя на главной показываются только 3.

**Решение**: Унифицировать query key в `PrefetchData` и `NewsSection`, и ограничить лимит до нужного количества.

### 2. Медленная загрузка валют — 6-12 секунд (Критично)

`fetch-stocks?type=currencies` занимает **6 414 мс** и даже **12 028 мс** из-за последовательного перебора 6 API с ошибками:

- Finnhub — нет данных
- Twelve Data — нет данных
- Yahoo Finance — 401 (невалидный ключ)
- Open Exchange Rates — 429
- CurrencyFreaks — 429
- ExchangeRate-API (frankfurter.app) — наконец работает

**Решение**: Добавить серверное кеширование в БД для валют. Если данные в БД моложе 30 минут — отдавать из кеша, не вызывая внешние API. Для валют этого достаточно, так как курсы обновляются медленно.

### 3. Огромный бандл аналитики — 450+ статей в коде (Критично для размера бандла)

Файл `analytics.ts` и 10 модулей `analytics-{author}.ts` содержат **полный текст 450+ статей** прямо в клиентском JavaScript. Файл `analytics.ts` один — 3079 строк, `analytics-christina.ts` — 6332+ строк. Примерная оценка: **2-4 МБ кода** в бандле только для статей.

**Решение**: Перенести аналитические статьи в базу данных. Создать таблицу `analytics_articles` и загружать данные через API. Это кардинально уменьшит размер бандла и ускорит загрузку.

### 4. Избыточная загрузка данных (Производительность)

- `fetchNews()` загружает **100 статей** (`limit=100`), но на главной показывает только 3
- `collectible_bills` загружается на каждой странице при открытии Sheet, но данные статичны — можно закешировать с большим staleTime

**Решение**: На главной ограничить лимит новостей до 6 (3 показываются + запас). Для `collectible_bills` установить длинный staleTime.

### 5. Неработающий Yahoo Finance API (Ошибки)

Каждый запрос к Yahoo Finance возвращает **401 Unauthorized**, тратя время и лимиты:

```
Yahoo Finance API error: 401
```

**Решение**: Убрать API ключ и отключить Yahoo Finance из цепочки fallback для валют и крипто, чтобы не тратить время на заведомо неудачные запросы.

### 6. `useReadingHistory` — заглушка без реализации

Хук `useReadingHistory.ts` содержит только комментарии "Mock - would use Supabase" без реальной логики. Если он используется в компонентах, это мертвый код.

---

## План реализации

### Фаза 1: Быстрые оптимизации (без изменения архитектуры)

**1.1 Исправить дублирование запросов новостей**

- `PrefetchData.tsx`: изменить queryKey на `['news', 'homepage']` и ограничить `fetchNews` лимитом 6
- `NewsSection.tsx`: оставить queryKey `['news', 'homepage']`, добавить `limit` параметр в `fetchNews`
- `news.ts`: добавить параметр `limit` в функцию `fetchNews()`

**1.2 Оптимизировать лимит загрузки новостей**

- `fetchNews()` — добавить параметр `limit` (по умолчанию 100, для главной — 6)

**1.3 Кешировать collectible_bills**

- Обернуть загрузку в React Query с `staleTime: 30 * 60 * 1000` (30 минут)

### Фаза 2: Оптимизация Edge Functions

**2.1 Серверное кеширование валют в fetch-stocks**

- В начале обработки `currencies` проверять таблицу `market_data_cache` в БД
- Если данные моложе 30 минут — отдавать из кеша
- Если данные устарели — проходить по API цепочке
- Ожидаемый результат: время ответа с 6-12 секунд до 100-200 мс в большинстве случаев

**2.2 Отключить Yahoo Finance из fallback**

- Убрать Yahoo Finance из цепочки fallback для валют (401 ошибка стабильно)
- Сократит время fallback на 1-2 секунды

### Фаза 3: Миграция аналитики в БД (крупное улучшение)

**3.1 Создать таблицу `analytics_articles**`

```
analytics_articles (
  id uuid PK,
  slug text UNIQUE,
  title text,
  excerpt text,
  content text,
  author text,
  type text,
  tags text[],
  image_url text,
  read_time text,
  published_at date,
  created_at timestamptz
)
```

**3.2 Миграция данных**

- Написать скрипт для переноса всех 450+ статей из кода в таблицу

**3.3 Обновить API**

- `fetchAnalytics()` → запрос к БД вместо импорта из файлов
- `fetchAnalyticsBySlug()` → запрос к БД
- Удалить файлы `analytics-*.ts` (экономия 2-4 МБ бандла)

### Фаза 4: Расширение функционала

**4.1 Реализовать `useReadingHistory**`

- Создать таблицу `reading_history` в БД
- Подключить к реальным данным через Supabase
- Использовать для улучшения рекомендаций в `PersonalizedContent`

---

## Технические детали

### Файлы для изменения (Фаза 1-2)


| Файл                                                      | Изменение                                    |
| --------------------------------------------------------- | -------------------------------------------- |
| `src/lib/api/news.ts`                                     | Добавить параметр `limit`                    |
| `src/components/prefetch/PrefetchData.tsx`                | Унифицировать queryKey, limit=6              |
| `src/components/home/NewsSection.tsx`                     | Добавить limit=6 в fetchNews                 |
| `src/components/collectibles/CollectiblesControlMenu.tsx` | Обернуть в useQuery                          |
| `supabase/functions/fetch-stocks/index.ts`                | Добавить DB-кеш для currencies, убрать Yahoo |


### Ожидаемый эффект


| Метрика                         | Было           | Станет               |
| ------------------------------- | -------------- | -------------------- |
| Запросов новостей на главной    | 2 x 100 статей | 1 x 6 статей         |
| Время загрузки валют            | 6-12 сек       | 100-200 мс (из кеша) |
| Размер JS бандла (аналитика)    | ~2-4 МБ        | ~0 (из БД)           |
| Количество edge function errors | ~10/загрузка   | ~2-3/загрузка        |
